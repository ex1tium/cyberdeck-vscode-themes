name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.
      - '*.*.*'   # Also support tags without 'v' prefix like 1.0.0, 1.2.3, etc.

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required to create releases and upload assets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Get version from tag
        id: get_version
        run: |
          # Extract version from tag (handle both v1.2.3 and 1.2.3 formats)
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $VERSION"

      - name: Verify package.json version matches tag
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Package.json version: $PACKAGE_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Error: package.json version ($PACKAGE_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi
          echo "âœ… Version verification passed"

      - name: Package extension
        run: |
          echo "ğŸ“¦ Creating VSIX package..."
          vsce package

          # Verify the VSIX file was created
          VSIX_FILE=$(ls *.vsix | head -n 1)
          if [ -z "$VSIX_FILE" ]; then
            echo "âŒ Error: No VSIX file was created"
            exit 1
          fi

          echo "âœ… Successfully created: $VSIX_FILE"
          echo "VSIX_FILE=$VSIX_FILE" >> $GITHUB_ENV

          # Show package contents for verification
          echo "ğŸ“‹ Package contents:"
          vsce ls
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: '*.vsix'
          generate_release_notes: true
          draft: false
          prerelease: false
          name: "Cyberdeck v${{ steps.get_version.outputs.VERSION }}"
          tag_name: ${{ github.ref_name }}
          body: |
            ## ğŸ‰ Cyberdeck v${{ steps.get_version.outputs.VERSION }}

            A retro-futuristic neural interface for the modern code cowboy. This release includes the packaged VS Code extension ready for installation.

            ### ğŸ“¦ Installation Options

            **ğŸŒŸ From VS Code Marketplace (Recommended):**
            1. Open VS Code
            2. Go to Extensions (`Ctrl+Shift+X` / `Cmd+Shift+X`)
            3. Search for **"Cyberdeck"**
            4. Click **Install**

            **ğŸ“ From VSIX file:**
            1. Download the `.vsix` file below
            2. Open VS Code
            3. Go to Extensions (`Ctrl+Shift+X` / `Cmd+Shift+X`)
            4. Click the **"..."** menu â†’ **"Install from VSIX..."**
            5. Select the downloaded file

            **ğŸ’» From command line:**
            ```bash
            code --install-extension cyberdeck-${{ steps.get_version.outputs.VERSION }}.vsix
            ```

            ### ğŸ“‹ What's Included
            - 10 cyberpunk-inspired theme variants (9 dark + 1 light)
            - Semantic highlighting support for 30+ languages
            - First-class support for TypeScript, Rust, Go, Python, Java, Zig, and Lua
            - Custom terminal colors and UI theming per variant
            - High contrast design for reduced eye strain

            ### ğŸ“ What's Changed
            See the [CHANGELOG](https://github.com/ex1tium/cyberdeck-vscode-themes/blob/main/CHANGELOG.md) for detailed changes in this version.

            ### ğŸ”— Links
            - [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=ex1tium.cyberdeck)
            - [GitHub Repository](https://github.com/ex1tium/cyberdeck-vscode-themes)
            - [Documentation](https://github.com/ex1tium/cyberdeck-vscode-themes#readme)
            - [Report Issues](https://github.com/ex1tium/cyberdeck-vscode-themes/issues)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "ğŸ‰ Successfully created release for Cyberdeck v${{ steps.get_version.outputs.VERSION }}"
          echo "ğŸ“¦ VSIX file: cyberdeck-${{ steps.get_version.outputs.VERSION }}.vsix"
          echo "ğŸ”— Release URL: ${{ steps.create_release.outputs.url }}"
          echo ""
          echo "âœ… Release completed successfully!"
          echo ""
          echo "ğŸ“‹ Next steps:"
          echo "1. The release is now available on GitHub with the VSIX file attached"
          echo "2. Users can download and install the VSIX file directly"
          echo "3. Consider publishing to VS Code Marketplace if not automated"
          echo "4. Announce the release to users and community"

